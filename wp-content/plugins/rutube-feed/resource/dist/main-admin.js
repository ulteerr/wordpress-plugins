function u(s,r,l="block"){s.style.display=r?l:"none"}function b(s){u(s,!0),u(s.previousElementSibling,!1);const r=s.closest(".video-thumbnail"),l=r==null?void 0:r.querySelector(".play-button");l&&u(l,!0)}function x(s){b(s),s.src="https://via.placeholder.com/320x180?text=No+Image"}document.addEventListener("DOMContentLoaded",function(){let s=1;const r=document.getElementById("rutube-video-container"),l=r==null?void 0:r.querySelector(".rutube-video-grid"),p=r==null?void 0:r.dataset.channel,v=r==null?void 0:r.dataset.limit,h=document.getElementById("rutube-loading-items");let m=!1;async function y(a,t=!1){if(m)return;m=!0;const e=new FormData;e.append("action","load_admin_videos"),e.append("post_id",rutubeAdminParams.post_id),e.append("channel",p),e.append("limit",v),e.append("page",a);try{const o=await(await fetch(rutubeAdminParams.ajax_url,{method:"POST",body:e})).json();o.success&&(l.innerHTML=t?l.innerHTML+o.data.html:o.data.html,document.querySelectorAll(".lazy-thumbnail").forEach(d=>{d.addEventListener("load",function(){b(this)}),d.addEventListener("error",function(){x(this)})}),E(o.data.has_more,o.data.count))}catch(n){console.error("Ошибка загрузки видео:",n)}finally{m=!1}}function E(a,t){if(h.innerHTML="",a&&t){const e=document.createElement("button");e.textContent="Показать ещё",e.classList.add("next-page"),e.addEventListener("click",n=>{n.preventDefault(),m||(s++,y(s,!0))}),h.appendChild(e)}}function L(){const a=document.getElementById("rutube-modal"),t=document.getElementById("rutube-iframe"),e=document.querySelector(".modal-close");document.addEventListener("click",n=>{if(n.target.classList.contains("play-button")){n.preventDefault();const o=n.target.getAttribute("data-src");o&&(t.src=o,u(a,!0,"flex"))}(n.target===a||n.target===e)&&(u(a,!1),t.src="")})}function _(){const a=document.querySelectorAll(".rutube-tabs-nav a"),t=document.querySelectorAll(".tab-content");a.forEach(e=>{e.addEventListener("click",function(n){n.preventDefault(),a.forEach(c=>c.classList.remove("active")),t.forEach(c=>c.classList.remove("active")),this.classList.add("active");const o=document.querySelector(this.getAttribute("href"));o==null||o.classList.add("active"),(o==null?void 0:o.querySelectorAll(".editor-template")).forEach(c=>{c&&c._codeMirrorInstance&&setTimeout(()=>{c._codeMirrorInstance.refresh()},50)})})})}const f=document.getElementById("clear-rutube-cache"),i=document.getElementById("cache-message-box");rutubeAdminParams.cache_enabled?f&&f.addEventListener("click",async function(a){a.preventDefault();const t=new FormData;t.append("action","clear_videos_cache"),t.append("channel",p);try{const n=await(await fetch(rutubeAdminParams.ajax_url,{method:"POST",body:t})).json();n.success?(i.textContent=n.data.message,i.style.color="green",await new Promise(o=>setTimeout(o,1500)),location.reload()):(i.textContent="Ошибка очистки кеша",i.style.color="red")}catch{i.textContent="Ошибка запроса",i.style.color="red"}}):(i.style.color="red",i.innerHTML="Объектный кеш не активирован! Установите и настройте Redis или Memcached.",f&&(f.style.display="none"));function g(a,t){if(typeof t<"u"){const e=a.getValue(),n=t(e,{indent_size:4,wrap_line_length:80,preserve_newlines:!0});a.setValue(n)}else console.error("js-beautify не загружен!")}document.querySelectorAll(".editor-template").forEach(a=>{const t=CodeMirror.fromTextArea(a,{mode:a.dataset.editorMode??"htmlmixed",theme:"dracula",lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0,styleActiveLine:!0,keyMap:"sublime",matchBrackets:!0,extraKeys:{"Ctrl-D":"duplicateLine"}});t.options.mode==="htmlmixed"&&t.setOption("extraKeys",{"Ctrl-I":function(e){g(e,html_beautify)}}),t.options.mode==="css"&&t.setOption("extraKeys",{"Ctrl-I":function(e){g(e,css_beautify)}}),a._codeMirrorInstance=t,t.on("change",function(){a.value=t.getValue()}),CodeMirror.commands.duplicateLine=function(e){var n=e.getCursor(),o=e.getLine(n.line);e.replaceRange(o+`
`,{line:n.line,ch:0})},document.querySelectorAll(".editor-buttons button").forEach(e=>{e.addEventListener("click",function(n){n.preventDefault();const o=this.getAttribute("data-insert");if(t){const d=t.getDoc(),c=d.getCursor();d.replaceRange(o,c)}})})}),y(s),L(),_()});
